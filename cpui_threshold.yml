# ---
# - name: check CPU Utilization
#   hosts: localhost
#   gather_facts: no

#   tasks:
#     - name: Get CPU Utilization
#       shell: top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}'
#       register: cpu_utilization

#     - name: Display CPU Utilization
#       debug:
#         msg: "cpu utilization is {{ cpu_utilization.stdout }}"
---
- name: check cpu utilization
  hosts: localhost
  gather_facts: no

  Vars:
    cpu_threshold: "6%"

  tasks:
    - name: get cpu utilization
      shell: top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1"%"}'
      register: cpu_utilization

    - name: check cpu utilization against threshold
      debug: 
        msg: |
          CPU Utilization is {{ cpu_utilization.stdout }}.
          Threshold value is {{ cpu_threshold }}.

    - name: comapre cpu utilization against threshold
      set_fact: 
        threshold_exceeded: "{{ cpu_utilization.stdout | float > cpu_threshold | replace('%', '') | float }}"

    - name: wait for 20 second if cpu utilization exceeds threshold
      pause:
        seconds: 10
      when: threshold_exceeded

    - name: display result
      debug:
        msg: "CPU Utilization is {{ cpu_utilization.stdout }}. {{ 'Over Threshold' if threshold_exceeded else 'Under Threshold' }}"
